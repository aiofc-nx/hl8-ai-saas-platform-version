# IAM 规范（草案）

## 1. 背景与目标

- 本规范依据 `docs/designs/iam-v2.md`、`docs/designs/casl-muti-tenant-auth-cqrs-es-eda.md`、`docs/designs/saas-platform-iam-plan.md` 及多租户培训材料编制，确保 IAM 底座开发遵循宪章的中文优先、技术栈约束与测试原则。
- 目标是在统一的中文语境下，明确 IAM 多租户身份与授权能力的架构原则、阶段计划、角色职责、合规检查与风险应对策略，为团队在 CQRS + ES + EDA 架构中构建一致的身份与权限能力提供权威指南。
- 规范适用于架构团队、各子域负责人（租户、组织、认证、授权、共享内核、基础设施、接口层）、治理团队、测试团队等所有直接或间接构建 IAM 能力的成员。
- 规范的变更、评审与发布流程遵循 `docs/governance/iam-specification-governance.md`，所有版本须记录在 `docs/governance/iam-specification-change-log.md` 并按模板执行 Constitution Check。

> **引用**：
>
> - 《IAM 系统开发方案（v2）》：整体架构、分层职责、关键示例。
> - 《CASL 多租户认证授权设计规范》：权限建模、事件溯源、能力缓存策略。
> - 《SaaS 平台 IAM 底座开发计划》：阶段划分、任务拆解与风险控制。

## 2. 架构原则

1. **多层上下文显式传递**（参考 D1 §2，D5）：所有接口、命令、查询、事件处理必须显式携带 `tenantId`、`organizationId`、`departmentIds`，在进入应用层前完成校验；缺失上下文的请求必须被拒绝并记录审计日志。
2. **CQRS + ES + EDA 一体化**（参考 D1 §2.2、D2 §3-4）：命令侧使用事件溯源记录权限变更，查询侧依赖读模型与能力缓存提供快速评估；事件驱动流程负责刷新缓存与投影，保证最终一致性。
3. **CASL 权限模型统一**（参考 D2 §2-4）：授权策略统一通过 CASL 生成与校验，能力构建须复用 `CaslAbilityFactory`，并在授权变更时触发 `SpecificationUpdatedEvent` 或缓存刷新任务。
4. **基础设施复用**（宪章 III、V-VIII）：配置、日志、异常、缓存等基础能力必须依赖 `@hl8/config`、`@hl8/logger`、`libs/infra/exceptions`、`libs/infra/cache` 及 `libs/infra/mikro-orm-nestjs`，禁止引入平行实现。
5. **中文文档与 TSDoc**（宪章 I、II）：公共 API、聚合、命令、事件需提供中文 TSDoc 注释，规范更新时必须同步代码与文档，确保“代码即文档”原则落地。

## 3. 多租户上下文责任

| 层级                   | 责任说明                                                                                            | 校验要点                                                               | 风险与防控                                                                                 |
| ---------------------- | --------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------- | ------------------------------------------------------------------------------------------ |
| 接口层（REST/GraphQL） | 控制器、守卫、拦截器从安全上下文注入租户/组织/部门信息，并在进入应用层前校验                        | 确保上下文字段齐全、来源可信，拒绝跨租户请求                           | 风险：缺失上下文导致越权访问；防控：`MultiTenantAuthGuard` 强制验证，失败时返回审计日志    |
| 应用层（CQRS）         | 命令/查询处理器继承 `MultiTenantCommandHandler`/`MultiTenantQueryHandler`，验证租户状态与 CASL 权限 | 使用 `CaslAbilityService` 校验 action/subject，记录审计；Saga 触发补偿 | 风险：权限缓存脏读；防控：命令执行前刷新能力缓存，异常时抛出自定义多租户错误               |
| 领域层                 | 聚合根继承 `MultiTenantAggregateRoot` 或事件溯源基类，保障聚合内租户一致性                          | 事件需携带租户标识，禁止跨租户聚合操作；值对象校验组织/部门归属        | 风险：事件流混租；防控：事件存储按租户命名空间隔离，载入历史前检查租户一致性               |
| 基础设施层             | `BaseTenantRepository`、CLS、事件存储、投影服务、缓存统一实现租户隔离                               | 查询必带租户/组织/部门过滤条件，缓存 key 带租户维度                    | 风险：缓存污染或读模型混租；防控：在 `libs/infra/cache` 定义命名规范，读模型订阅器校验租户 |

## 4. 阶段计划

| 阶段               | 目标                                                                           | 关键交付物                                                           | 质量门槛                                                       | 建议时长 |
| ------------------ | ------------------------------------------------------------------------------ | -------------------------------------------------------------------- | -------------------------------------------------------------- | -------- |
| 阶段一：基础骨架   | 落地多租户命令/查询基类、CLS、最小 API，打通最小多租户链路                     | `MultiTenantCommand/Query` 基类、`TenantContextModule`、最小链路演示 | 单元测试覆盖 ≥80%；最小链路通过 E2E；上下文校验日志无异常      | 2-3 周   |
| 阶段二：协议与授权 | 实现 OAuth2/OIDC/SAML、CASL 能力工厂、事件驱动刷新，实现多协议认证与权限一致性 | 协议守卫、CASL 能力缓存、事件处理器、Feature Flag                    | 能力缓存刷新 ≤2 分钟；事件投影滞后 <30 秒；关键接口 p95 <250ms | 3-4 周   |
| 阶段三：组织与审计 | 完成组织/部门聚合、审计服务联通、灰度准备，保证跨层级权限与审计可追溯          | 组织树查询、审计日志、跨租户校验示例、灰度策略                       | 关键路径测试覆盖 ≥90%；审计事件可追溯率 100%；灰度回滚演练完成 | 3 周     |
| 阶段四：测试与治理 | 完成单元/集成/E2E、宪章检查、上线准备，输出治理与验收资料                      | 测试报告、Constitution Check、集成验收清单、上线 checklist           | 所有宪章检查项通过；无 P0/P1 缺陷；上线清单获批准并归档        | 2 周     |

## 5. 职责矩阵

| 角色                                | 主要职责                                                  | 决策权    | 参与度 | 关键接口                           |
| ----------------------------------- | --------------------------------------------------------- | --------- | ------ | ---------------------------------- |
| 架构负责人                          | 维护规范、主持评审、裁决架构设计分歧、确认阶段目标        | A（批准） | R      | 子域负责人、治理团队、平台基础设施 |
| 子域负责人（租户/组织/认证/授权等） | 提供子域交付计划、实现遵循规范、反馈依赖与风险            | R         | A      | 架构负责人、平台基础设施团队       |
| 治理团队                            | 执行 Constitution Check、维护变更日志与评审记录、跟踪补救 | C         | R      | 架构负责人、测试与质量团队         |
| 平台基础设施团队                    | 提供配置、日志、异常、缓存、CLS、事件存储等共享能力支持   | C         | C      | 子域负责人、架构负责人             |
| 测试与质量团队                      | 设计分层测试策略、验证覆盖率指标、出具测试与审计报告      | C         | R      | 子域负责人、治理团队               |
| 安全与合规团队                      | 评估跨租户安全、协议合规、日志脱敏等工作                  | C         | I      | 架构负责人、治理团队               |

> R：Responsible；A：Accountable；C：Consulted；I：Informed。

## 6. 合规检查与风险缓解

### 6.1 Constitution Check 执行指引

| 检查项                  | 依据             | 证据来源                                  | 记录位置                                               |
| ----------------------- | ---------------- | ----------------------------------------- | ------------------------------------------------------ |
| 中文注释与文档覆盖      | 宪章 I、II       | 代码审阅记录、TSDoc 截图                  | `docs/governance/iam-specification-review-template.md` |
| 技术栈一致性            | 宪章 III         | `package.json`、`tsconfig.json`、依赖清单 | 同上                                                   |
| 多租户上下文校验        | D1 §2、§4        | 命令/查询处理器示例、集成测试报告         | 同上                                                   |
| CASL 权限一致性         | D2 §3-§4         | 能力缓存刷新日志、投影数据快照            | 同上                                                   |
| 审计与事件追踪          | 宪章 IV、D2 §4.2 | AuditService 日志、事件总线订阅记录       | 同上                                                   |
| 配置/日志/异常/缓存规范 | 宪章 V-VIII      | 模块引入截图、配置类定义、日志样例        | 同上                                                   |

执行步骤：

1. 治理团队运行 `pnpm run iam:constitution-check` 生成 JSON + Markdown 报告，并将输出归档至 `docs/governance/reports/`。
2. 依据 `docs/governance/iam-specification-review-template.md` 填写每条检查项的证据路径、结论与补救计划。
3. 若检查失败，必须在表单中登记责任人、截止日期，并在补救完成后再次运行脚本确认。

### 6.2 风险预案与补救流程

| 风险             | 触发条件                                   | 响应动作                                                         | 责任角色                           | 记录位置               |
| ---------------- | ------------------------------------------ | ---------------------------------------------------------------- | ---------------------------------- | ---------------------- |
| 权限缓存滞后     | 能力刷新超出 2 分钟或缓存命中率 <90%       | 触发能力重建任务、清理缓存并记录 `SpecificationUpdatedEvent`     | Authorization 子域负责人、治理团队 | 事件总线日志、评审模板 |
| 认证协议整合延迟 | 协议落地超出阶段二预计时长或安全评估未通过 | 启用 Feature Flag、采用 Mock，评估上线风险并更新阶段计划         | Auth 子域负责人、架构负责人        | 规范变更日志、阶段报告 |
| 跨租户数据泄露   | 安全测试或监控发现跨租户访问               | 立即冻结相关账户、执行审计回溯、发布补救脚本、通知治理渠道       | 架构负责人、平台基础设施团队       | 审计日志、补救报告     |
| 文档漂移         | PR 或评审中发现实现与规范不一致            | 先更新规范并登记 `SpecificationUpdatedEvent`，再允许代码变更合入 | 架构负责人、子域负责人             | 变更日志、评审记录     |

补救流程：当任一高优风险发生，按照 `docs/governance/iam-specification-governance.md` 中的 Amending 流程提交提案 → 召开评审会 → 发布 `SpecificationUpdatedEvent` → 更新变更日志 → 归档补救报告。

## 7. 变更流程

1. 触发条件：宪章更新、设计文档调整、阶段评审结论、治理检查缺口。
2. 提案：由责任人创建变更提案，提交至规范维护会评审。
3. 审批：架构负责人与治理团队联合审批并更新 `docs/governance/iam-specification-change-log.md`。
4. 通知：向所有子域负责人与相关团队发布变更摘要，必要时召开对齐会。
5. 落地：更新对应实现、测试与文档，执行补偿或回溯任务。

---

> 本文档为 Phase 1 产出的大纲版本，后续阶段将持续补充详细内容与引用。**_ End Patch_**

## 附录：参考资料

| 文档编号 | 标题                                                     | 摘要                                                                           | 链接                                                 |
| -------- | -------------------------------------------------------- | ------------------------------------------------------------------------------ | ---------------------------------------------------- |
| D1       | IAM 系统开发方案（v2）                                   | 描述 IAM 分层架构、子域职责、CQRS/ES 示例，实现本规范架构原则的核心依据        | `/docs/designs/iam-v2.md`                            |
| D2       | 基于 CASL + CQRS + ES + EDA 的多租户认证授权全栈设计规范 | 定义 CASL 权限模型、事件溯源聚合、能力缓存刷新与治理流程                       | `/docs/designs/casl-muti-tenant-auth-cqrs-es-eda.md` |
| D3       | SaaS 平台 IAM 底座开发计划                               | 拆解四个发展阶段、关键任务、风险与里程碑，为本规范的阶段计划与职责矩阵提供指导 | `/docs/designs/saas-platform-iam-plan.md`            |
| D4       | 多租户设计指南                                           | 补充租户/组织/部门建模、跨层权限继承与数据隔离最佳实践                         | `/docs/training/multi-tenant-design.md`              |
| D5       | 多租户认证培训材料                                       | 覆盖安全上下文、认证协议接入、兼容策略，辅助阶段二工作                         | `/docs/training/muti-tenant-auth.md`                 |
| D6       | MikroORM + NestJS 使用手册                               | 说明事件存储、仓储封装与多租户订阅器的实现方式                                 | `/libs/infra/mikro-orm-nestjs/README.md`             |

> 若新增参考资料，请同步更新编号与摘要，确保所有链接为仓库内绝对路径。
