## 多租户 IAM 领域边界补充说明

### 1. 文档背景与目标
- 本文档作为 `docs/designs/casl-muti-tenant-auth-cqrs-es-eda.md` 的补充，聚焦说明 IAM（认证授权域）与用户、组织/部门、租户等相邻领域的职责边界与协作模式。
- 目标：在遵循 DDD、CQRS、ES、EDA 架构前提下，明确领域解耦策略、上下文传递方式以及跨域集成契约，保障多租户平台的演进性与一致性。

### 2. 领域职责划分概述
- **IAM 领域**：负责权限策略建模、CASL 规则生成、命令/查询权限校验、事件驱动的能力同步。
- **用户领域**：负责用户生命周期、身份信息、认证方式，输出 `UserId` 及与租户、组织的绑定关系。
- **组织与部门领域**：管理组织层级、部门编制、岗位等结构化信息，输出 `OrganizationId`、`DepartmentId`、层级视图。
- **租户领域**：负责租户生命周期、状态、套餐与资源隔离策略，输出 `TenantId` 及租户配置。
- 各领域保持高内聚，通过契约化接口或事件协作，避免领域内逻辑散落至 IAM 模块。

### 3. 模块边界与对外能力
#### 3.1 IAM 模块
- **核心职责**：多租户权限策略、命令/查询权限校验、CASL 能力缓存、权限事件发布。
- **对外接口**：
  - 命令/查询控制器（依赖 `SecurityContext`）；
  - CASL 规则查询接口（供前端或其他服务使用）；
  - 权限变更事件（`PermissionChangedEvent`、`RoleAssignedEvent` 等）。

#### 3.2 用户模块
- **核心职责**：用户注册、信息维护、账号锁定解锁、跨租户绑定。
- **对外接口**：
  - 用户查询 API：返回用户基本信息、关联租户与组织 ID；
  - 用户状态事件：`UserCreatedEvent`、`UserDisabledEvent` 等；
  - 身份凭证验证服务：提供认证结果与 `UserId`。

#### 3.3 组织与部门模块
- **核心职责**：组织结构维护、部门层级管理、岗位编制。
- **对外接口**：
  - 组织/部门查询 API：支持根据 `OrganizationId`、`DepartmentId` 获取层级信息；
  - 组织变更事件：`OrganizationUpdatedEvent`、`DepartmentMovedEvent`；
  - 组织上下文服务：根据用户或租户返回默认组织、部门。

#### 3.4 租户模块
- **核心职责**：租户开通、套餐/配额、启停流程与合规审计。
- **对外接口**：
  - 租户查询 API：返回租户状态、配置（如计费、地域、特性开关）；
  - 租户生命周期事件：`TenantActivatedEvent`、`TenantSuspendedEvent`；
  - 资源隔离策略服务：提供数据库、缓存命名空间映射等信息。

### 4. 集成契约与通信模式
- **API 契约**：各模块通过明确定义的 REST/gRPC/GraphQL 接口提供查询能力，接口需带版本号并以中文 TSDoc 描述字段语义。
- **事件契约**：跨域变更通过事件总线传播，事件载荷必须包含 `tenantId`、`organizationId`、`departmentIds` 等上下文，遵循 `@hl8/logger` 追踪字段规范。
- **同步校验**：IAM 在命令执行前通过用户/组织/租户模块的同步接口校验实体状态，避免使用过期缓存。
- **异步更新**：IAM 订阅相邻领域事件以更新本地读模型或触发能力缓存刷新，确保最终一致性。

### 5. 安全上下文传递策略
- `SecurityContext` 由网关或接口层构建，字段来源如下：
  - `userId`：用户模块认证结果；
  - `tenantId`：租户模块返回的租户绑定；
  - `organizationId` / `departmentIds`：组织模块查询或事件缓存；
  - 补充字段：租户状态、组织层级路径、部门岗位等可选信息。
- IAM 在命令/查询处理器中仅消费上下文本身，不直接调用相邻领域内部逻辑；如需实时校验，必须通过公开接口或缓存。

### 6. 事件驱动与缓存策略
- **事件订阅列表**：
  - `UserCreatedEvent`、`UserDisabledEvent` → 触发能力缓存清理；
  - `TenantActivatedEvent`、`TenantSuspendedEvent` → 更新租户状态读模型；
  - `OrganizationUpdatedEvent`、`DepartmentMovedEvent` → 校正组织/部门维度权限。
- **缓存更新顺序**：
  1. 接收事件，记录审计日志；
  2. 更新 IAM 内部投影（例如用户权限投影中的组织路径）；
  3. 清理对应的 CASL 能力缓存键；
  4. 触发能力重建任务。
- **回源策略**：缓存失效或投影缺失时，IAM 应优先调用相邻领域查询接口，避免直接依赖事件一致性。

### 7. 测试与治理要求
- **契约测试**：为 API/事件定义契约测试用例，确保版本升级不破坏依赖方；测试用例放置在 `tests/integration/contracts/`。
- **演练场景**：模拟用户停用、租户冻结、组织重构等业务场景，验证 IAM 的权限撤销、缓存刷新、命令拒绝逻辑。
- **治理机制**：版本变更需召开跨领域评审，使用共享的变更日志模板记录影响分析与回滚方案。

### 8. 总结
- 通过将用户、组织/部门、租户领域独立成模块，并与 IAM 领域进行契约化协作，可保持领域高内聚、低耦合。
- IAM 仅依赖标准化上下文与事件，实现权限判定、能力同步的闭环；相邻领域负责各自复杂业务场景，从根源保证数据权威性。
- 此补充说明为后续团队协作、测试编排与变更治理提供统一参考，保障多租户平台在演进过程中维持一致的权限策略与安全边界。

