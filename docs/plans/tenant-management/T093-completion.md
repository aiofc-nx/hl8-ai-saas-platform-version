# T093 å®ŒæˆæŠ¥å‘Šï¼šSaga ä¸šåŠ¡é€»è¾‘å®ç°

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. Saga åŸºç¡€ç»“æ„å®Œå–„

- âœ… æ·»åŠ  `CommandBus` å’Œ `EventBus` ä¾èµ–æ³¨å…¥
- âœ… å®ç°ç³»ç»Ÿå®‰å…¨ä¸Šä¸‹æ–‡åˆ›å»ºæ–¹æ³• `createSystemSecurityContext()`
- âœ… å®Œå–„äº‹ä»¶å¤„ç†æ–¹æ³•çš„ç»“æ„å’Œé”™è¯¯å¤„ç†

### 2. ç§Ÿæˆ·åˆ›å»º Saga å®ç°

- âœ… å®ç° `onTenantCreated()` æ–¹æ³•
- âœ… æ·»åŠ  Saga ID ç”Ÿæˆå’Œæ—¥å¿—è®°å½•
- âœ… é¢„ç•™åˆ›å»ºé»˜è®¤ç»„ç»‡æ ¹èŠ‚ç‚¹çš„æ¥å£ï¼ˆç­‰å¾…ç»„ç»‡æ¨¡å—å®ç°ï¼‰
- âœ… é¢„ç•™åˆå§‹åŒ– IAM åŸºç¡€è§’è‰²çš„æ¥å£ï¼ˆç­‰å¾… IAM æ¨¡å—å®ç°ï¼‰
- âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œè¡¥å¿äº‹ä»¶é¢„ç•™æ¥å£

### 3. ç§Ÿæˆ·æ¿€æ´» Saga å®ç°

- âœ… å®ç° `onTenantActivated()` æ–¹æ³•
- âœ… æ·»åŠ  Saga ID ç”Ÿæˆå’Œæ—¥å¿—è®°å½•
- âœ… é¢„ç•™å‘é€æ¬¢è¿é€šçŸ¥çš„æ¥å£ï¼ˆç­‰å¾…é€šçŸ¥æœåŠ¡å®ç°ï¼‰
- âœ… é¢„ç•™åˆå§‹åŒ–é»˜è®¤é…ç½®çš„æ¥å£ï¼ˆç­‰å¾…é…ç½®æœåŠ¡å®ç°ï¼‰
- âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œè¡¥å¿äº‹ä»¶é¢„ç•™æ¥å£

### 4. ç§Ÿæˆ·åœç”¨ Saga å®ç°

- âœ… å®ç° `onTenantSuspended()` æ–¹æ³•
- âœ… æ·»åŠ  Saga ID ç”Ÿæˆå’Œæ—¥å¿—è®°å½•
- âœ… é¢„ç•™è§¦å‘ IAM ç¦ç”¨æƒé™çš„æ¥å£ï¼ˆç­‰å¾… IAM æ¨¡å—å®ç°ï¼‰
- âœ… é¢„ç•™é€šçŸ¥æ¶ˆæ¯ç³»ç»Ÿçš„æ¥å£ï¼ˆç­‰å¾…æ¶ˆæ¯æœåŠ¡å®ç°ï¼‰
- âœ… æ·»åŠ é”™è¯¯å¤„ç†å’Œè¡¥å¿äº‹ä»¶é¢„ç•™æ¥å£

## ğŸ“ å®ç°ç»†èŠ‚

### Saga ç»“æ„

```typescript
@Injectable()
@EventsHandler(TenantCreatedEvent, TenantActivatedEvent, TenantSuspendedEvent)
export class TenantLifecycleSaga implements IEventHandler<...> {
  constructor(
    private readonly commandBus: CommandBus,
    private readonly eventBus: EventBus,
    private readonly logger: LoggerService,
  ) {}
}
```

### ç³»ç»Ÿå®‰å…¨ä¸Šä¸‹æ–‡

```typescript
private createSystemSecurityContext(tenantId: string): SecurityContext {
  return {
    tenantId,
    userId: "system",
    organizationIds: [],
    departmentIds: [],
    metadata: {
      source: "TenantLifecycleSaga",
      operation: "tenant_initialization",
    },
  };
}
```

### ç§Ÿæˆ·åˆ›å»º Saga æµç¨‹

1. **ç›‘å¬äº‹ä»¶**ï¼š`TenantCreatedEvent`
2. **ç”Ÿæˆ Saga ID**ï¼š`tenant_init_{tenantId}_{timestamp}`
3. **åˆ›å»ºç³»ç»Ÿå®‰å…¨ä¸Šä¸‹æ–‡**
4. **æ­¥éª¤ 1**ï¼šåˆ›å»ºé»˜è®¤ç»„ç»‡æ ¹èŠ‚ç‚¹ï¼ˆé¢„ç•™æ¥å£ï¼‰
5. **æ­¥éª¤ 2**ï¼šåˆå§‹åŒ– IAM åŸºç¡€è§’è‰²ï¼ˆé¢„ç•™æ¥å£ï¼‰
6. **é”™è¯¯å¤„ç†**ï¼šè®°å½•è¡¥å¿äº‹ä»¶ï¼ˆé¢„ç•™æ¥å£ï¼‰

### ç§Ÿæˆ·æ¿€æ´» Saga æµç¨‹

1. **ç›‘å¬äº‹ä»¶**ï¼š`TenantActivatedEvent`
2. **ç”Ÿæˆ Saga ID**ï¼š`tenant_activation_{tenantId}_{timestamp}`
3. **åˆ›å»ºç³»ç»Ÿå®‰å…¨ä¸Šä¸‹æ–‡**
4. **æ‰§è¡Œåˆå§‹åŒ–æ“ä½œ**ï¼šå‘é€æ¬¢è¿é€šçŸ¥ã€åˆå§‹åŒ–é»˜è®¤é…ç½®ï¼ˆé¢„ç•™æ¥å£ï¼‰
5. **é”™è¯¯å¤„ç†**ï¼šè®°å½•è¡¥å¿äº‹ä»¶ï¼ˆé¢„ç•™æ¥å£ï¼‰

### ç§Ÿæˆ·åœç”¨ Saga æµç¨‹

1. **ç›‘å¬äº‹ä»¶**ï¼š`TenantSuspendedEvent`
2. **ç”Ÿæˆ Saga ID**ï¼š`tenant_suspension_{tenantId}_{timestamp}`
3. **åˆ›å»ºç³»ç»Ÿå®‰å…¨ä¸Šä¸‹æ–‡**
4. **æ­¥éª¤ 1**ï¼šè§¦å‘ IAM ç¦ç”¨æƒé™ï¼ˆé¢„ç•™æ¥å£ï¼‰
5. **æ­¥éª¤ 2**ï¼šé€šçŸ¥æ¶ˆæ¯ç³»ç»Ÿï¼ˆé¢„ç•™æ¥å£ï¼‰
6. **é”™è¯¯å¤„ç†**ï¼šè®°å½•è¡¥å¿äº‹ä»¶ï¼ˆé¢„ç•™æ¥å£ï¼‰

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ¨¡å—ä¾èµ–**ï¼š
   - Saga ä¸­çš„æŸäº›æ­¥éª¤éœ€è¦ç­‰å¾…å…¶ä»–æ¨¡å—å®ç°ï¼ˆç»„ç»‡æ¨¡å—ã€IAM æ¨¡å—ç­‰ï¼‰
   - å½“å‰å®ç°æä¾›äº†å®Œæ•´çš„æ¡†æ¶å’Œé¢„ç•™æ¥å£
   - å½“ç›¸å…³æ¨¡å—å®ç°åï¼Œåªéœ€å–æ¶ˆæ³¨é‡Šç›¸åº”ä»£ç å³å¯

2. **Saga å¤±è´¥å¤„ç†**ï¼š
   - Saga å¤±è´¥ä¸åº”è¯¥é˜»æ­¢ä¸»ä¸šåŠ¡æµç¨‹ï¼ˆç§Ÿæˆ·åˆ›å»º/æ¿€æ´»/åœç”¨ï¼‰
   - ä¸»ä¸šåŠ¡æµç¨‹å·²ç»å®Œæˆï¼ŒSaga åªæ˜¯åç»­çš„åˆå§‹åŒ–/æ¸…ç†æµç¨‹
   - å¤±è´¥æ—¶ä¼šè®°å½•è¡¥å¿äº‹ä»¶ï¼Œæ”¯æŒåç»­é‡è¯•

3. **å¹‚ç­‰æ€§**ï¼š
   - æ‰€æœ‰ Saga æ­¥éª¤éƒ½åº”è¯¥æ˜¯å¹‚ç­‰çš„
   - æ”¯æŒé‡å¤æ‰§è¡Œè€Œä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨

4. **æ—¥å¿—è®°å½•**ï¼š
   - æ‰€æœ‰ Saga æ­¥éª¤éƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•
   - åŒ…å« Saga IDã€ç§Ÿæˆ· ID ç­‰å…³é”®ä¿¡æ¯
   - ä¾¿äºé—®é¢˜æ’æŸ¥å’Œå®¡è®¡

## ğŸ”„ åç»­å·¥ä½œ

- [ ] å½“ç»„ç»‡æ¨¡å—å®ç°åï¼Œå–æ¶ˆæ³¨é‡Šåˆ›å»ºé»˜è®¤ç»„ç»‡çš„ä»£ç 
- [ ] å½“ IAM æ¨¡å—å®ç°åï¼Œå–æ¶ˆæ³¨é‡Šåˆå§‹åŒ–è§’è‰²çš„ä»£ç 
- [ ] å½“é€šçŸ¥æœåŠ¡å®ç°åï¼Œå–æ¶ˆæ³¨é‡Šå‘é€é€šçŸ¥çš„ä»£ç 
- [ ] å½“æ¶ˆæ¯æœåŠ¡å®ç°åï¼Œå–æ¶ˆæ³¨é‡Šé€šçŸ¥æ¶ˆæ¯ç³»ç»Ÿçš„ä»£ç 
- [ ] å®šä¹‰è¡¥å¿äº‹ä»¶ç±»å‹ï¼ˆTenantInitializationFailedEvent ç­‰ï¼‰
- [ ] å®ç°è¡¥å¿äº‹ä»¶å¤„ç†å™¨ï¼Œæ”¯æŒè‡ªåŠ¨é‡è¯•
- [ ] æ·»åŠ  Saga çŠ¶æ€è·Ÿè¸ªï¼ˆå¯é€‰ï¼‰
