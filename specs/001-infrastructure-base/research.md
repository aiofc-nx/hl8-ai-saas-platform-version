# 技术研究：基础设施基础模块

**日期**：2024-12-19  
**关联计划**：[plan.md](./plan.md)

## 技术决策

### 1. 事件存储实现

**决策**：使用 MikroORM + PostgreSQL 实现事件存储

**理由**：

- 符合项目技术栈约束（MikroORM + PostgreSQL）
- PostgreSQL 支持 ACID 事务，确保事件写入的原子性
- MikroORM 提供类型安全的数据访问层
- 支持乐观锁机制检测版本冲突
- 支持多租户隔离和索引优化

**替代方案考虑**：

- DynamoDB/云原生事件存储：需要额外的云服务依赖，增加复杂度
- MongoDB：不适合关系型数据查询，缺乏事务支持
- 自研事件存储：开发成本高，维护负担大

### 2. 事件版本冲突处理

**决策**：使用乐观锁机制检测冲突，冲突时自动重试指定次数

**理由**：

- 乐观锁性能优于悲观锁，适合高并发场景
- 自动重试可以处理大多数临时冲突
- 重试次数可配置，平衡性能和成功率
- 符合事件溯源的最佳实践

**替代方案考虑**：

- 悲观锁：性能较差，不适合高并发场景
- 冲突队列：增加系统复杂度，延迟写入
- 立即返回错误：需要调用方处理重试逻辑，增加使用复杂度

### 3. 服务降级策略

**决策**：分级降级策略

**理由**：

- 缓存不可用时降级到直接查询：保证功能可用性，性能略有下降
- 存储不可用时写入本地队列：保证数据不丢失，服务恢复后自动重试
- 消息队列不可用时仅记录日志：不阻塞主流程，保证系统可用性
- 分级降级策略平衡了可用性和数据完整性

**替代方案考虑**：

- 直接返回错误：用户体验差，可用性低
- 全部降级到本地存储：可能丢失数据，性能下降
- 根据服务重要性决定：实现复杂度较高，维护成本高

### 4. 权限缓存失效策略

**决策**：多级失效策略（用户、租户、全局）

**理由**：

- 用户权限变更时仅失效该用户的缓存：最小化影响范围，保持高性能
- 租户权限变更时失效该租户所有用户的缓存：确保租户内权限一致性
- 全局权限变更时失效全部缓存：确保所有用户使用最新策略
- 多级失效策略平衡了性能和准确性

**替代方案考虑**：

- 全局失效：性能影响大，缓存命中率低
- 仅失效相关用户：可能遗漏相关用户（如同一租户下的其他用户）
- 失效相关租户：可能影响未变更的用户

### 5. 数据保留策略

**决策**：永久保留，支持可选归档到成本更低的存储

**理由**：

- 事件和审计记录的永久保留符合合规要求
- 归档功能可以降低存储成本
- 归档后仍可查询，保证数据可追溯性
- 符合事件溯源和审计追踪的最佳实践

**替代方案考虑**：

- 配置保留期限：可能影响长期追溯能力
- 按租户配置不同策略：实现复杂度较高
- 永久保留不归档：存储成本持续增长

### 6. 消息队列适配器

**决策**：支持 Kafka、RabbitMQ、RocketMQ 等多种实现

**理由**：

- 提供适配器接口，支持多种消息队列实现
- 默认实现 Kafka（企业级场景常用）
- 支持扩展点，可以根据业务需求选择不同的消息队列
- 符合可扩展性要求

**替代方案考虑**：

- 仅支持 Kafka：限制灵活性，无法适应不同场景
- 自研消息总线：开发成本高，维护负担大

### 7. 缓存驱动

**决策**：默认 Redis，支持内存缓存（测试用）

**理由**：

- Redis 是企业级缓存的标准选择
- 支持分布式缓存，适合多租户场景
- 内存缓存用于单元测试，提供测试替身
- 支持扩展点，可以根据业务需求选择不同的缓存驱动

**替代方案考虑**：

- 仅支持 Redis：限制灵活性，无法适应不同场景
- 自研缓存：开发成本高，维护负担大

### 8. 审计存储

**决策**：默认 PostgreSQL，支持扩展 MongoDB、Elasticsearch

**理由**：

- PostgreSQL 支持 ACID 事务，确保审计记录的完整性
- 支持全文索引，便于审计记录查询
- MongoDB 支持文档存储，适合非结构化数据
- Elasticsearch 支持全文搜索，适合审计日志分析

**替代方案考虑**：

- 仅支持 PostgreSQL：限制灵活性，无法适应不同场景
- 自研审计存储：开发成本高，维护负担大

## 技术风险

### 1. 事件存储性能

**风险**：大量事件写入可能导致性能瓶颈

**缓解措施**：

- 使用事件快照机制减少事件重放次数
- 优化数据库索引（tenant_id、version、aggregate_id）
- 支持事件归档，将历史事件迁移到低成本存储
- 监控事件写入性能，及时发现问题

### 2. 版本冲突处理

**风险**：高并发场景下版本冲突频繁，自动重试可能失败

**缓解措施**：

- 配置合理的重试次数和重试间隔
- 监控版本冲突率，及时调整策略
- 提供明确的错误信息，方便问题诊断
- 支持手动重试机制

### 3. 服务降级

**风险**：服务降级可能导致数据丢失或性能下降

**缓解措施**：

- 本地队列持久化，确保数据不丢失
- 监控服务健康状态，及时恢复服务
- 提供降级指标，便于问题诊断
- 支持手动触发服务恢复

### 4. 权限缓存失效

**风险**：缓存失效不完整可能导致权限不一致

**缓解措施**：

- 多级失效策略确保失效完整性
- 监控缓存命中率，及时发现异常
- 提供缓存预热机制，减少缓存失效影响
- 支持手动触发缓存失效

### 5. 数据归档

**风险**：归档过程中可能出现数据丢失或查询失败

**缓解措施**：

- 归档前备份数据，确保数据完整性
- 归档过程中支持查询，不影响业务
- 监控归档过程，及时发现问题
- 支持归档数据恢复机制

## 技术依赖

### 1. 外部依赖

- `@hl8/config`：配置管理
- `@hl8/logger`：日志输出
- `@hl8/mikro-orm-nestjs`：数据库访问
- `@casl/ability`：权限规则构建
- `@nestjs/cqrs`：事件总线
- `nestjs`：基础框架
- `fastify`：HTTP 服务器
- `mikro-orm`：ORM 框架
- `postgresql`：关系型数据库
- `redis`：缓存服务
- `kafka`：消息队列（可选）

### 2. 内部依赖

- `libs/infra/exceptions`：异常定义
- `libs/infra/cache`：缓存管理
- `libs/infra/mikro-orm-nestjs`：数据库管理

### 3. 依赖管理

- 使用 pnpm workspace 管理版本
- 所有依赖必须声明在 `package.json` 中
- 禁止直接使用未声明的依赖

## 技术规范

### 1. 代码规范

- 所有代码必须使用 TypeScript，遵循 NodeNext 模块系统
- 所有公共 API 必须使用中文 TSDoc 注释
- 所有代码必须通过 ESLint 检查
- 所有代码必须通过 TypeScript 类型检查

### 2. 测试规范

- 单元测试必须与被测文件同目录旁放，命名 `{filename}.spec.ts`
- 集成测试必须集中放置在 `tests/integration/` 目录
- 核心业务逻辑测试覆盖率必须达到 80% 以上
- 关键路径测试覆盖率必须达到 90% 以上
- 所有公共 API 必须具备测试用例

### 3. 文档规范

- 所有文档必须使用中文
- 所有 API 文档必须使用 TSDoc 格式
- 所有配置文档必须包含字段说明和示例
- 所有错误文档必须包含错误码和错误信息

## 技术评审

### 评审要点

1. **架构设计**：是否符合 DDD + Clean Architecture + CQRS + Event Sourcing + EDA 架构模式
2. **多租户隔离**：是否确保跨租户数据访问的隔离性达到 100%
3. **性能指标**：是否满足性能目标（写入成功率、响应时间、缓存命中率等）
4. **可靠性**：是否支持分级降级和服务恢复
5. **可测试性**：是否提供测试替身和支持单元测试
6. **可扩展性**：是否支持扩展点和自定义实现
7. **可维护性**：是否提供统一的接口和文档

### 评审流程

1. 技术方案设计
2. 技术方案评审
3. 代码实现
4. 代码评审
5. 测试验证
6. 性能测试
7. 安全扫描
8. 上线部署

## 技术路线图

### Phase 1：核心功能实现（当前阶段）

- 事件存储实现（MikroORM + PostgreSQL）
- 事件发布实现（NestJS CQRS + 消息队列适配器）
- 权限缓存实现（CASL + Redis）
- 审计服务实现（MikroORM + PostgreSQL）
- 配置管理实现（@hl8/config）
- 异常处理实现（libs/infra/exceptions）

### Phase 2：高级功能实现

- 事件快照机制
- 事件归档功能
- 审计记录归档功能
- 权限缓存预热机制
- 服务降级机制
- 监控指标采集

### Phase 3：扩展功能实现

- 多消息队列适配器支持
- 多缓存驱动支持
- 多审计存储支持
- 性能优化
- 安全加固

## 参考资料

- [Event Sourcing 最佳实践](https://martinfowler.com/eaaDev/EventSourcing.html)
- [CQRS 模式](https://martinfowler.com/bliki/CQRS.html)
- [CASL 权限管理](https://casl.js.org/)
- [NestJS CQRS](https://docs.nestjs.com/recipes/cqrs)
- [MikroORM 文档](https://mikro-orm.io/)
- [PostgreSQL 文档](https://www.postgresql.org/docs/)
- [Redis 文档](https://redis.io/documentation)
