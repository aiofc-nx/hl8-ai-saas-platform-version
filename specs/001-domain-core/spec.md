# 功能规格：平台领域核心能力

**特性分支**：`001-domain-base`  
**创建日期**：2025-11-11  
**状态**：草稿  
**输入**：用户描述：“根据docs/designs/platform-domain-baseline.md和docs/designs/platform-domain-design.md开发@hl8/domain-base，我已经创建了项目的项目结构”

## 用户场景与测试（必填）

### 用户故事 1 - 快速建立聚合基线（优先级：P1）

作为平台领域架构师，我希望可以直接复用统一的聚合根、实体和值对象基类，以便在新建领域模块时快速落地租户隔离、审计与软删除约束。

**优先级理由**：所有领域模块都依赖该能力，没有它就无法在平台范围内推进统一建模。

**独立验证方式**：通过在示例领域模块中引用 `@hl8/domain-base` 并创建聚合，验证租户断言、审计字段和软删除状态均可直接使用。

**验收场景**：

1. **Given** 架构师在新建聚合根时引用平台基类，**When** 通过聚合构造函数创建实例，**Then** 聚合自动包含租户、审计与版本字段且通过 `ensureValidState` 校验。
2. **Given** 聚合根执行删除操作，**When** 调用软删除方法，**Then** 聚合状态记录删除操作者、时间并阻止跨租户访问。

---

### 用户故事 2 - 保障领域事件一致性（优先级：P2）

作为应用层开发者，我希望聚合根能够收集并发布附带租户上下文的领域事件，使得事件总线可以安全地驱动读模型与跨域流程。

**优先级理由**：事件是实现 CQRS、EDA 的关键，缺乏统一事件契约会导致跨模块集成失败。

**独立验证方式**：在示例命令处理器中触发聚合行为，检查 `pullDomainEvents` 返回的事件结构与租户上下文是否完整。

**验收场景**：

1. **Given** 聚合根内部状态发生变化，**When** 调用聚合行为方法，**Then** 自动向事件队列加入包含 `tenantId`、`triggeredBy` 的领域事件。

---

### 用户故事 3 - 规范仓储接口（优先级：P3）

作为领域工程师，我希望仓储接口具备统一的查询、保存与软删除契约，以便在基础设施层实现持久化时保持一致的多租户过滤策略。

**优先级理由**：仓储接口是跨团队协作的基线，统一规范能减少集成返工。

**独立验证方式**：在示例仓储实现中对照接口契约，实现并通过自动化测试验证 `save`、`findById`、`findBy` 等方法对租户上下文的处理。

**验收场景**：

1. **Given** 领域工程师在基础设施层实现仓储接口，**When** 调用 `save` 持久化聚合，**Then** 多租户上下文被完整传递且软删除记录默认被过滤。

### 边界情形

- 当聚合根或实体缺少租户上下文时，系统必须拒绝构造或变更并返回领域异常。
- 当不同租户的实体尝试在同一聚合中关联时，系统必须抛出跨租户操作异常并阻止持久化。
- 当软删除状态重复设置或恢复时，应保持幂等，不允许多次修改同一删除记录。
- 当领域事件缺少操作人信息时，事件仍需携带审计元数据以保证后续追溯。

## 需求（必填）

### 功能性需求

- **FR-001**：系统必须提供可复用的聚合根基类，内置租户/组织/部门断言、审计字段、软删除状态与版本控制能力。
- **FR-002**：系统必须提供聚合内实体与值对象基类，保证等值比较、不可变性以及中文 TSDoc 业务注释。
- **FR-003**：系统必须提供统一的标识和值对象集合，包括租户、用户、组织、部门 ID 及时间值对象，禁止领域模块直接使用原始类型。
- **FR-004**：系统必须提供领域事件基类与事件收集机制，确保每个事件自动携带租户上下文、审计元数据与触发人信息。
- **FR-005**：系统必须定义仓储接口规范，覆盖 `findById`、`findBy`、`save`、`delete` 等方法，并明确软删除过滤与租户隔离约束。
- **FR-006**：系统必须提供领域服务接口与守卫工具，支持跨聚合业务规则的纯领域实现。
- **FR-007**：系统必须暴露审计轨迹与软删除值对象，支持审计信息的创建、更新、删除与恢复全过程。
- **FR-008**：系统必须提供统一的 UUID 生成器接口，并保证所有聚合根与实体默认使用该生成器产生标识。
- **FR-009**：系统必须提供模板或示例文档，指导领域团队如何在新模块中接入 `@hl8/domain-base` 并满足 DDD + 多租户要求。
- **FR-010**：系统必须预置质量要求说明，包括单元测试覆盖率门槛、事件契约测试与文档更新规范。

### 核心实体（若功能涉及数据模型请保留本节）

- **AggregateRootBase**：平台聚合根抽象，负责统一的不变式校验、租户隔离、审计轨迹与领域事件收集。
- **EntityBase**：聚合内部实体基类，可选开启审计字段，用于描述与聚合根关联的业务对象。
- **AggregateId**：聚合标识值对象，封装 UUID 生成与等值比较。
- **TenantId / OrganizationId / DepartmentId / UserId**：多租户上下文标识值对象，确保跨模块一致表达与校验。
- **AuditTrail**：审计轨迹值对象，追踪创建与更新的操作者和时间。
- **SoftDeleteStatus**：软删除状态值对象，记录删除与恢复信息并保证幂等。
- **DomainEventBase**：领域事件基类，承载事件标识、发生时间、聚合标识与上下文。
- **RepositoryInterface**：仓储接口契约，定义聚合持久化和查询的统一标准。
- **DomainGuards**：领域守卫工具集合，提供通用的断言与验证逻辑。

## 假设与依赖

- 平台已统一采用 Node.js + TypeScript 技术栈，领域团队具备基础的 DDD 建模能力。
- 应用层与基础设施层遵循现有 CQRS/ES/EDA 基线，可直接消费 `@hl8/domain-base` 提供的领域事件与接口。
- 依赖的 `@hl8/logger`、`@hl8/config` 等平台库已在其他基线中落实，本功能聚焦领域层能力而不重复实现。

## 成功标准（必填）

### 可量化结果

- **SC-001**：平台内新增领域模块中至少 90% 在首个迭代内完成 `@hl8/domain-base` 接入并通过审计、租户隔离验证。
- **SC-002**：基于 `@hl8/domain-base` 创建聚合的脚手架或示例项目，可在 30 分钟内完成从初始化到触发首个领域事件的演示。
- **SC-003**：领域事件契约在跨模块集成测试中保持 100% 通过率，未出现因上下文缺失导致的回归。
- **SC-004**：平台架构评审中，与领域层建模规范相关的返工单量在发布后两个迭代内减少 60% 以上。
