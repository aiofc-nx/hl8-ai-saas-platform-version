# Feature Specification: IAM 基线规范落地

**Feature Branch**: `001-define-iam-spec`  
**Created**: 2025-11-11  
**Status**: Draft  
**Input**: User description: "我们开始开发iam，首先你要全面了解docs/designs目录下的内容，然后结合上面的讨论内容指定规范文档"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 架构负责人统一规范 (Priority: P1)

作为 IAM 架构负责人，我需要一份整合宪章与现有设计文档的中文规范，以便团队能在统一约束下启动开发。

**Why this priority**: 没有统一规范将导致多租户、安全、事件驱动等核心约束无法落实，项目风险最高。

**Independent Test**: 在评审会上仅凭该规范即可验证核心原则是否覆盖，确认团队能据此启动阶段一开发。

**Acceptance Scenarios**:

1. **Given** 已完成对 `docs/designs` 文档的解读，**When** 输出规范初稿，**Then** 规范必须引用并同步《IAM 宪章》《CASL 设计》《IAM v2 架构》关键要求。
2. **Given** 架构委员会审阅规范，**When** 对照宪章核对，**Then** 所有核心原则均能在规范中找到明确条目和执行说明。

---

### User Story 2 - 子域负责人规划交付 (Priority: P2)

作为子域负责人（租户、组织、认证、授权等），我希望规范明确阶段目标、职责分工与交付检查点，从而能制定各自的开发计划与测试策略。

**Why this priority**: 子域划分与交付节奏决定迭代成效，优先级次于整体架构，但仍对上线节奏影响重大。

**Independent Test**: 通过规范即可拆解子域里程碑与验收标准，不依赖外部资料完成阶段计划。

**Acceptance Scenarios**:

1. **Given** 子域负责人阅读规范，**When** 制定阶段一至阶段四交付计划，**Then** 每个阶段均有明确任务列表、里程碑输出与质量标准。
2. **Given** 规范中的职责划分，**When** 子域负责人交叉校验依赖，**Then** 发现的依赖冲突可在规范中定位并获得解决指引。

---

### User Story 3 - 治理团队执行审计 (Priority: P3)

作为平台治理与质量团队，我需要通过规范快速检查 IAM 开发是否符合多租户隔离、日志审计、配置管理和异常处理等宪章要求。

**Why this priority**: 治理检查发生在开发之后，重要但不阻断前期设计，因此列为 P3。

**Independent Test**: 使用规范附录与检查清单，可独立完成一次 Constitution Check 并形成报告。

**Acceptance Scenarios**:

1. **Given** 治理团队依据规范执行 Constitution Check，**When** 对照列出的检查项逐条核对，**Then** 能覆盖租户隔离、CASL 权限、日志与异常等全部条款。
2. **Given** 规范中提供的风险与补救策略，**When** 治理团队发现缺口，**Then** 可以依照建议启动补救或需求变更流程。

---

### Edge Cases

- 当宪章更新导致规范条目冲突时，必须在 2 个工作日内触发文档修订流程并向所有子域发布变更通知。
- 若阶段目标因外部依赖（如共享库未完成）推迟，规范需提供临时替代策略或特性开关指引，避免阻塞关键路径。
- 当多租户安全测试发现跨租户访问风险时，规范应指向必须执行的紧急审计、事件补偿与回溯步骤。

## Requirements _(mandatory)_

### Functional Requirements

- **FR-001**: 规范必须总结 `docs/designs/iam-v2.md`、`docs/designs/casl-muti-tenant-auth-cqrs-es-eda.md` 与 `docs/designs/saas-platform-iam-plan.md` 的核心结论，输出统一本体。
- **FR-002**: 规范必须明确多租户上下文（租户、组织、部门）在接口层、应用层、领域层及基础设施层的责任边界与校验要求。
- **FR-003**: 规范必须列出四个交付阶段的目标、关键交付物、质量门槛以及建议时长，供迭代计划采纳。
- **FR-004**: 规范必须定义角色职责矩阵，覆盖架构负责人、子域负责人、治理团队、平台基础设施团队，并说明沟通与审批机制。
- **FR-005**: 规范必须提供测试与合规要求，包括单元/集成/E2E 覆盖率目标、宪章检查流程、事件驱动一致性验证方式。
- **FR-006**: 规范必须梳理依赖与风险，并给出至少三项缓解策略（如能力缓存延迟、认证协议排期、跨租户数据校验）。
- **FR-007**: 规范必须附带变更与版本管理流程，确保后续文档更新可追踪且与代码基线同步。

### Key Entities _(include if feature involves data)_

- **IAM 规范主体**: 记录架构原则、阶段目标、职责矩阵与质量标准，是开发与审计的权威依据。
- **子域交付清单**: 针对租户、组织、认证、授权、共享内核、基础设施与接口层列出的交付任务与验收标准。
- **合规检查清单**: 支撑治理团队执行 Constitution Check、CASL 权限校验、日志与审计检查的条目集合。

## 假设与限制

- 假设现有《宪章》与三份设计文档为最新版本；若存在多人并行更新，需要在规范发布前完成同步协作会。
- 假设平台仍采用 Node.js + TypeScript + NestJS + MikroORM 技术栈，并已具备 `@hl8/config`、`@hl8/logger` 等统一基础设施。
- 限制：规范仅约束 IAM 底座与其直接依赖，不覆盖后续业务模块的细节实现。

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 规范发布后 3 个工作日内，架构委员会完成签批且无 P0/P1 级别缺陷。
- **SC-002**: 各子域负责人在规范发布后 5 个工作日内提交经规范对齐的阶段计划，提交率达到 100%。
- **SC-003**: 首轮 Constitution Check 基于规范执行时，覆盖率达到 100%，且所有检查项能在规范中找到对应条目。
- **SC-004**: 在阶段一结束时的复盘会议上，参会成员满意度（通过会后问卷）≥ 90%，确认规范为主要依据完成协同。
