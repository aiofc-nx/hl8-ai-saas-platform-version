# 功能规格：租户管理模块

**特性分支**：`002-tenant-management`  
**创建日期**：2025-01-27  
**状态**：草稿  
**输入**：用户描述："开发租户管理模块docs/designs/tenant-minimal-design.md"

## Clarifications

### Session 2025-01-27

- Q: 租户操作需要什么权限级别？ → A: 超级管理员（SUPER_ADMIN）和平台管理员（ADMIN）均可执行所有租户操作（创建、启用、停用、归档）
- Q: 外部依赖失败时的处理策略是什么？ → A: 租户操作成功，事件发布失败时记录错误并异步重试（最终一致性）
- Q: 租户名称的校验规则是什么？ → A: 长度 1-100 字符，允许中文、英文、数字、连字符和下划线
- Q: 联系人信息的校验规则是什么？ → A: 邮箱必须符合标准邮箱格式，电话为可选且支持国际格式（+国家代码）
- Q: 租户上下文的必填字段是什么？ → A: 默认组织根节点和默认时区为必填，货币为可选

## 用户场景与测试（必填）

### 用户故事 1 - 系统管理员创建新租户（优先级：P1）

超级管理员或平台管理员需要为新的企业客户创建租户账户，以便该企业能够使用平台服务。创建租户时，系统需要收集租户的基本信息（名称、联系方式、组织上下文等），并确保租户名称的唯一性。创建成功后，系统应自动初始化租户的基础上下文（如默认组织节点、时区等），并发布租户创建事件，以便IAM系统能够订阅并初始化该租户的权限体系。

**优先级理由**：租户创建是租户管理的基础能力，是后续所有租户操作的前提。没有租户创建功能，整个多租户系统无法启动。

**独立验证方式**：通过执行创建租户操作，验证系统能够成功创建租户、生成唯一标识、初始化上下文并发布事件。对用户带来的价值是能够快速为新客户开通服务。

**验收场景**：

1. **Given** 系统中不存在名称为"ABC公司"的租户，**When** 超级管理员或平台管理员提交创建租户请求（包含租户名称、联系人信息、组织上下文），**Then** 系统创建租户成功，返回租户唯一标识，租户状态为"已初始化"，并发布租户创建事件
2. **Given** 系统中已存在名称为"ABC公司"的租户，**When** 超级管理员或平台管理员尝试创建同名租户，**Then** 系统拒绝创建并返回"租户名称已存在"的错误提示
3. **Given** 超级管理员或平台管理员提交的租户名称包含非法字符或超出长度限制，**When** 系统验证租户信息，**Then** 系统拒绝创建并返回具体的校验错误信息
4. **Given** 租户创建成功，**When** 系统初始化租户上下文，**Then** 系统为租户设置默认组织根节点、默认时区等基础上下文信息

---

### 用户故事 2 - 系统管理员启用租户（优先级：P1）

超级管理员或平台管理员需要启用已创建但尚未激活的租户，或重新启用被暂停的租户。启用操作将改变租户状态，使租户能够正常使用平台服务，并通知IAM系统为该租户启用权限访问。

**优先级理由**：租户启用是租户生命周期管理的关键环节，使新创建的租户能够开始使用服务，或恢复被暂停租户的服务。

**独立验证方式**：通过执行启用租户操作，验证系统能够成功将租户状态从"已初始化"或"已暂停"转换为"已激活"，并发布启用事件。对用户带来的价值是能够控制租户的服务访问权限。

**验收场景**：

1. **Given** 租户状态为"已初始化"或"已暂停"，**When** 超级管理员或平台管理员执行启用租户操作，**Then** 租户状态变更为"已激活"，系统发布租户启用事件，IAM系统接收到事件后为该租户启用权限
2. **Given** 租户状态为"已激活"，**When** 超级管理员或平台管理员尝试启用该租户，**Then** 系统提示"租户已处于激活状态"或忽略该操作
3. **Given** 租户已被软删除（归档），**When** 超级管理员或平台管理员尝试启用该租户，**Then** 系统拒绝操作并返回"无法启用已归档的租户"的错误提示

---

### 用户故事 3 - 系统管理员停用租户（优先级：P1）

超级管理员或平台管理员需要暂停租户的服务访问，通常用于租户违反服务条款、欠费或临时维护等情况。停用操作将改变租户状态，使租户无法继续使用平台服务，并通知IAM系统禁用该租户的权限访问。

**优先级理由**：租户停用是租户管理的重要安全控制手段，能够及时阻止问题租户继续使用服务，保护平台和其他租户的利益。

**独立验证方式**：通过执行停用租户操作，验证系统能够成功将租户状态从"已激活"转换为"已暂停"，并发布停用事件。对用户带来的价值是能够快速响应安全或合规问题。

**验收场景**：

1. **Given** 租户状态为"已激活"，**When** 超级管理员或平台管理员执行停用租户操作，**Then** 租户状态变更为"已暂停"，系统发布租户停用事件，IAM系统接收到事件后禁用该租户的权限访问
2. **Given** 租户状态为"已暂停"或"已初始化"，**When** 超级管理员或平台管理员尝试停用该租户，**Then** 系统提示"租户当前状态不允许停用操作"或忽略该操作
3. **Given** 租户已被软删除（归档），**When** 超级管理员或平台管理员尝试停用该租户，**Then** 系统拒绝操作并返回"无法停用已归档的租户"的错误提示

---

### 用户故事 4 - 系统管理员归档租户（优先级：P2）

超级管理员或平台管理员需要永久删除租户账户，但保留历史数据用于审计和合规要求。归档操作将软删除租户，标记租户为已归档状态，并通知计费系统和其他相关系统该租户已不再活跃。

**优先级理由**：租户归档是租户生命周期的最终环节，满足数据保留和合规要求，同时清理不再活跃的租户资源。

**独立验证方式**：通过执行归档租户操作，验证系统能够成功软删除租户、标记归档状态、发布归档事件，并在查询时默认隐藏已归档租户。对用户带来的价值是能够安全地清理不再需要的租户数据。

**验收场景**：

1. **Given** 租户处于任意状态（已初始化、已激活或已暂停），**When** 超级管理员或平台管理员执行归档租户操作，**Then** 租户被标记为软删除状态，系统发布租户归档事件，计费系统接收到事件后停止计费
2. **Given** 租户已被归档，**When** 超级管理员或平台管理员查询租户列表（默认查询），**Then** 已归档的租户不出现在查询结果中
3. **Given** 租户已被归档，**When** 超级管理员或平台管理员明确指定查询包含已删除记录，**Then** 已归档的租户出现在查询结果中，并标记为已归档状态

---

### 用户故事 5 - IAM系统查询租户上下文（优先级：P1）

IAM系统需要查询租户的上下文信息（如默认组织ID、默认时区、货币等），以便在权限验证和策略应用时使用正确的租户上下文。

**优先级理由**：租户上下文查询是IAM系统正常运行的基础依赖，确保权限验证能够基于正确的租户上下文进行。

**独立验证方式**：通过IAM系统调用租户上下文查询接口，验证系统能够返回完整的租户上下文信息。对用户带来的价值是确保权限系统能够正确识别和应用租户级别的策略。

**验收场景**：

1. **Given** 租户已创建且处于激活状态，**When** IAM系统查询该租户的上下文信息，**Then** 系统返回租户的默认组织ID、默认时区、货币等上下文信息
2. **Given** 租户已被归档，**When** IAM系统查询该租户的上下文信息，**Then** 系统返回错误提示"租户不存在或已归档"，或返回空结果

---

### 用户故事 6 - 系统管理员查询租户列表（优先级：P2）

超级管理员或平台管理员需要查看和管理平台中的所有租户，支持按状态、创建时间、关键字等条件过滤和分页查询，以便进行租户管理和监控。

**优先级理由**：租户列表查询是租户管理的基础功能，使管理员能够全面了解平台租户情况，支持日常管理和监控工作。

**独立验证方式**：通过执行租户列表查询操作，验证系统能够返回符合条件的租户列表，支持分页和过滤。对用户带来的价值是提供租户管理的可视化视图。

**验收场景**：

1. **Given** 系统中存在多个租户（包含不同状态），**When** 超级管理员或平台管理员查询租户列表（不指定过滤条件），**Then** 系统返回所有未归档的租户列表，按创建时间倒序排列，支持分页
2. **Given** 超级管理员或平台管理员指定按状态过滤（如仅查询"已激活"的租户），**When** 系统执行查询，**Then** 系统仅返回符合状态条件的租户列表
3. **Given** 超级管理员或平台管理员使用关键字搜索租户名称，**When** 系统执行查询，**Then** 系统返回名称包含关键字的租户列表
4. **Given** 超级管理员或平台管理员查询租户列表，**When** 系统返回结果，**Then** 每个租户信息包含租户ID、名称、状态、创建时间、联系方式等基本信息

---

### 边界情形

- 当租户名称包含不允许的字符（如特殊符号、控制字符等）或超出长度限制时，系统应拒绝创建并返回具体的校验错误信息
- 当联系人邮箱格式不符合标准邮箱格式时，系统应拒绝创建并返回邮箱格式错误提示
- 当提供的联系人电话格式不符合国际格式（如缺少国家代码前缀）时，系统应拒绝创建并返回电话格式错误提示
- 当并发创建同名租户时，系统应通过唯一性约束确保只有一个租户创建成功
- 当租户状态不允许执行某个操作时（如对已归档租户执行启用操作），系统应返回明确的错误提示
- 当查询租户时租户不存在，系统应返回"租户不存在"的错误提示，而不是抛出未处理的异常
- 当事件发布失败时，系统应记录错误日志并支持异步重试机制，租户操作本身不应因事件发布失败而失败
- 当IAM系统、计费系统、组织管理模块等外部依赖失败时，系统应记录失败信息并支持后续补偿处理，租户操作应成功完成，通过异步重试确保最终一致性

## 需求（必填）

### 功能性需求

- **FR-001**：系统必须允许超级管理员或平台管理员创建新租户，包括收集租户名称、联系人信息（负责人姓名、邮箱、电话）、组织上下文（默认组织根节点、默认时区、货币等）。邮箱必须符合标准邮箱格式，电话为可选字段，如提供则需支持国际格式（+国家代码）。组织上下文中，默认组织根节点和默认时区为必填字段，货币为可选字段
- **FR-002**：系统必须校验租户名称的唯一性，确保同一平台内不存在重复的租户名称
- **FR-003**：系统必须校验租户名称的长度和字符编码，租户名称长度必须在 1-100 字符之间，仅允许中文、英文、数字、连字符（-）和下划线（\_），拒绝不符合规范的租户名称
- **FR-004**：系统必须在创建租户时自动初始化租户的基础上下文，默认组织根节点和默认时区为必填字段，货币为可选字段
- **FR-005**：系统必须支持租户状态管理，包括"已初始化"、"已激活"、"已暂停"、"已归档"四种状态
- **FR-006**：系统必须允许超级管理员或平台管理员启用租户，将租户状态从"已初始化"或"已暂停"转换为"已激活"
- **FR-007**：系统必须校验租户状态转移的合法性，只允许从特定状态转移到目标状态（如只有"已初始化"或"已暂停"状态的租户可以激活）
- **FR-008**：系统必须允许超级管理员或平台管理员停用租户，将租户状态从"已激活"转换为"已暂停"
- **FR-009**：系统必须允许超级管理员或平台管理员归档租户，对租户执行软删除操作
- **FR-010**：系统必须在租户创建、启用、停用、归档时发布相应的领域事件，事件包含租户ID、租户名称、状态、审计元数据、软删除状态、租户上下文等完整信息
- **FR-011**：系统必须支持查询单个租户的详细信息，包括租户基本信息、状态、上下文等
- **FR-012**：系统必须支持分页查询租户列表，支持按状态、创建时间、关键字等条件过滤
- **FR-013**：系统必须在查询租户列表时默认排除已归档（软删除）的租户，除非明确指定包含已删除记录
- **FR-014**：系统必须支持IAM系统查询租户上下文信息，返回租户的默认组织ID、默认时区、货币等上下文
- **FR-015**：系统必须记录所有租户操作的审计信息，包括操作者、操作时间、操作类型等
- **FR-016**：系统必须确保所有租户操作都通过权限验证，只有超级管理员（SUPER_ADMIN）或平台管理员（ADMIN）角色才能执行租户管理操作（创建、启用、停用、归档），并确保租户数据的多租户隔离
- **FR-017**：系统必须确保租户数据的多租户隔离，防止跨租户的数据访问和操作
- **FR-018**：系统必须确保租户操作（创建、启用、停用、归档）的成功不依赖于外部系统（IAM、计费、组织管理）的同步响应，事件发布失败时应记录错误并支持异步重试，保证最终一致性

### 核心实体

- **租户（Tenant）**：租户聚合根，包含租户的唯一标识（UUID）、租户名称、状态、联系人信息、组织上下文、审计信息、软删除状态等。租户是租户管理领域的核心实体，负责维护租户的不变式和生命周期状态转移。

- **租户档案（TenantProfile）**：租户的扩展信息实体，包含法定名称、注册代码、行业分类等可选信息。租户档案作为租户聚合的一部分，可以独立更新但必须遵循租户的生命周期约束。

## 成功标准（必填）

### 可量化结果

- **SC-001**：系统管理员可以在2分钟内完成租户创建操作，从提交创建请求到收到成功响应（包括事件发布完成）
- **SC-002**：系统在1000个并发租户查询请求时性能稳定，95%的查询请求响应时间在1秒内完成
- **SC-003**：系统能够支持至少10,000个活跃租户的存储和查询，查询性能无明显降级
- **SC-004**：租户状态变更操作（启用、停用、归档）的成功率达到99.9%，失败操作能够被正确记录和告警
- **SC-005**：租户创建、启用、停用、归档事件的发布成功率达到99.9%，事件发布失败时系统能够记录错误并支持重试
- **SC-006**：IAM系统查询租户上下文的响应时间在500毫秒内完成，确保权限验证流程不受影响
- **SC-007**：系统管理员查询租户列表时，即使存在10,000个租户，分页查询的响应时间也在2秒内完成

## 假设

- 系统已具备平台领域基线能力，包括聚合根基类、审计能力、软删除能力、UUID生成器等
- 系统已具备平台应用层基线能力，包括CQRS命令/查询处理、事件溯源、事件驱动架构、Saga编排等
- 系统已具备权限验证基础设施，包括CASL权限策略和多租户认证守卫
- IAM系统已具备事件订阅能力，能够接收和处理租户生命周期事件
- 系统使用PostgreSQL作为关系型数据库，MongoDB作为文档型数据库（如需要）
- 系统已配置日志和监控基础设施，能够记录操作日志和性能指标

## 依赖关系

- **平台领域基线**：依赖平台提供的聚合根基类、审计值对象、软删除值对象、UUID生成器等基础能力
- **平台应用层基线**：依赖平台提供的CQRS命令/查询处理器基类、事件存储、事件总线、Saga编排等能力
- **IAM系统**：租户管理模块需要与IAM系统集成，通过事件发布通知IAM系统租户状态变更，并提供租户上下文查询接口供IAM系统调用
- **计费系统**：租户归档时需要通知计费系统停止计费（通过事件订阅实现）
- **组织管理模块**：租户创建时需要初始化默认组织根节点，可能需要调用组织管理模块的接口或通过事件驱动方式实现

## 非功能性需求

- **性能**：租户查询操作应支持高并发访问，单次查询响应时间不超过1秒（95分位）
- **可扩展性**：系统设计应支持未来扩展租户计费、配置中心等功能，不影响现有功能
- **可观测性**：系统应记录所有租户操作的执行时长、事件处理结果、Saga状态等，提供租户激活延迟、租户停用总数、租户投影滞后等关键指标
- **可靠性**：系统应确保租户状态变更的原子性，状态转移失败时应能够回滚或记录补偿操作。外部依赖（IAM、计费、组织管理）失败不应导致租户操作失败，应通过异步重试机制保证最终一致性
- **安全性**：所有租户操作必须通过权限验证，确保只有具备相应权限的用户才能执行操作，并确保租户数据的多租户隔离
