<!--
Sync Impact Report
- Version change: N/A → 1.0.0
- 新增原则: 中文优先原则, 代码即文档原则, 技术栈约束原则, 测试要求原则, 配置模块使用规范, 日志模块使用规范, 异常模块使用规范, 缓存模块使用规范, 数据库管理模块使用规范
- 新增章节: 附加约束, 开发治理流程
- 移除章节: 无
- 模板更新状态:
  ✅ .specify/templates/plan-template.md
  ✅ .specify/templates/spec-template.md
  ✅ .specify/templates/tasks-template.md
- 后续待办: 无
-->

# hl8-aisaas-platform Constitution

## Core Principles

### I. 中文优先原则

- 所有代码注释、技术文档、错误消息、日志输出及用户界面文案必须使用中文，且注释遵循 TSDoc 规范。
- Git 提交信息须使用英文描述；代码变量命名保持英文，但必须配有中文注释说明业务语义。

**理由**：统一中文语境提升团队沟通效率，确保业务认知一致，降低知识传递成本。

### II. 代码即文档原则

- 公共 API、类、方法、接口、枚举必须编写完整 TSDoc 注释，覆盖功能描述、业务规则、使用场景、前置条件、后置条件、异常抛出及注意事项。
- 代码变更时必须同步更新注释，确保实现与文档实时一致。

**理由**：高质量注释让代码成为权威业务文档，缩短交接时间并减少额外文档维护负担。

### III. 技术栈约束原则

- 全仓统一采用 Node.js + TypeScript，使用 pnpm 管理依赖并通过 monorepo 组织代码。
- 服务端项目必须启用 NodeNext 模块系统：`module` 与 `moduleResolution` 设为 `NodeNext`，`target` 设为 `ES2022`，并启用 `strict`。
- `package.json` 中必须声明 `type: "module"` 与 `engines: { "node": ">=20" }`，禁止新增 CommonJS 模块代码。
- 服务端基础框架固定为 NestJS + Fastify，禁止引入 Express 兼容层。
- 数据访问层统一使用 MikroORM 管理实体生命周期与迁移，关系型数据库锁定 PostgreSQL，文档型数据库锁定 MongoDB。
- 领域命令与查询处理必须引入 `@nestjs/cqrs` 实现 CQRS 分层，权限控制需统一使用 CASL (`@casl/ability`) 建模权限策略。

**理由**：统一技术栈与依赖选择提升跨团队协作效率，降低学习成本，并确保性能、扩展性与安全性的一致基线。

### IV. 测试要求原则

- 单元测试必须与被测文件同目录旁放，命名 `{filename}.spec.ts`。
- 集成测试与端到端测试必须分别集中在 `tests/integration/` 与 `tests/e2e/`。
- 必须采用单元、集成、端到端的分层测试策略，保证快速反馈与可维护性。
- 核心业务逻辑测试覆盖率必须达到 80% 以上，关键路径覆盖率必须达到 90% 以上，所有公共 API 必须具备测试用例。

**理由**：严格的测试体系保障关键功能可靠性，支撑快速迭代并防止回归。

### V. 配置模块使用规范

- 必须优先通过 `@hl8/config` 读取与管理配置，禁止直接使用原始配置对象。
- 每个配置必须定义 TypeScript 配置类，并使用 `class-validator` 装饰器声明字段校验逻辑。

**理由**：统一的配置入口与校验机制强化类型安全、运行时校验与文档一致性。

### VI. 日志模块使用规范

- 日志必须统一通过 `@hl8/logger` 输出，禁止直接使用 Nest 内置 `Logger` 或第三方日志库（如 `pino`、`winston` 等）。
- 扩展日志能力时必须先在 `@hl8/logger` 中实现标准化接口，再由业务模块复用。

**理由**：集中式日志体系保证日志格式一致、上下文完整与脱敏策略统一，提升可观测性。

### VII. 异常模块使用规范

- 异常处理必须统一依赖 `libs/infra/exceptions` 提供的异常定义与封装。
- 新增业务异常必须在该模块中声明异常类型、错误码与中文错误信息，禁止直接构造裸异常。
- 跨模块异常必须使用标准化转换与传播工具保持语义一致。

**理由**：统一异常语义避免重复实现，提升排障效率并确保错误信息一致。

### VIII. 缓存模块使用规范

- 缓存策略必须通过 `libs/infra/cache` 管理，禁止直接操作底层缓存驱动。
- 新增缓存命名空间或策略时必须在该模块内统一声明；扩展监控或降级能力时亦须先在该模块实现。

**理由**：集中管理缓存策略保持命名一致，避免资源浪费并强化系统可观测性。

### IX. 数据库管理模块使用规范

- 数据库连接、迁移与会话管理必须统一通过 `libs/infra/mikro-orm-nestjs` 模块完成。
- 禁止在业务模块内直接实例化数据库驱动或管理迁移脚本。

**理由**：统一数据库管理流程确保迁移安全、提升可维护性并降低数据一致性风险。

## 附加约束

- 项目目标：打造面向现代企业管理的 SaaS 平台，为多部门协同与业务自动化提供统一能力中心。
- 多租户能力为硬性要求，业务实现必须确保租户隔离、自助开通与生命周期管理策略完备。
- 数据存储与访问层必须实现严格的租户级数据隔离与安全防护。
- 业务模块开发必须遵循 DDD、Clean Architecture、CQRS、Event Sourcing 与事件驱动架构（EDA）的混合模式，确保系统可演化性与高可观测性。

## 开发治理流程

- 所有需求进入实现前必须通过 Constitution Check，确认语言规范、技术栈约束与测试策略均可满足。
- 方案设计文档必须明确数据流、事件流与多租户隔离策略，并在评审会议获得签字通过。
- 代码评审必须重点验证 TSDoc 完整性、测试覆盖率、异常与日志统一性，以及配置、缓存、数据库访问是否遵循约束。
- 上线前必须完成分层测试报告、性能基线验证，以及租户隔离安全扫描。

## Governance

- 本章程优先级高于项目内其他开发约定，出现冲突时必须以本章程为准。
- 任何章程变更必须由架构委员会提出议案，获得三分之二成员通过，并在合并前完成影响评估与迁移计划。
- 章程版本号遵循语义化版本：重大原则变更递增主版本，新增原则或大幅扩展指导递增次版本，表述澄清递增修订号。
- 每次修订必须更新本文件顶部同步影响报告，并在相关模板与运行指南中同步体现。
- 项目每季度至少进行一次合规巡检，验证代码库、文档与流程持续满足本章程要求。

**Version**: 1.0.0 | **Ratified**: 2025-11-11 | **Last Amended**: 2025-11-11
